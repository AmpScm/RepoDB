using Microsoft.Data.SqlClient;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using RepoDb.IntegrationTests.Setup;
using System.Data;

namespace RepoDb.IntegrationTests.Operations;

[TestClass]
public class ExecuteScalarTest
{
    [TestInitialize]
    public void Initialize()
    {
        Database.Initialize();
        Cleanup();
    }

    [TestCleanup]
    public void Cleanup()
    {
        Database.Cleanup();
    }

    #region ExecuteScalar

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithoutRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT * FROM (SELECT 1 AS Column1) TMP WHERE 1 = 0;");

            // Assert
            Assert.IsNull(result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithSingleRowAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT 1;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithMultipleRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT 2 UNION ALL SELECT 1;");

            // Assert
            Assert.AreEqual(2, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithSingleRowAndWithMultipleColumnsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT 1 AS Value1, 2 AS Value2;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithSingleParameterAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT @Value1;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithMultipleParametersAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = 1
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT @Value1, @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarWithMultipleParametersAndWithMultipleRowsAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = DateTime.UtcNow.AddDays(1)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("SELECT @Value1 AS Value1 UNION ALL SELECT @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarByExecutingAStoredProcedureWithSingleParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.ExecuteScalar("[dbo].[sp_get_identity_table_by_id]",
                param: new { tables.Last().Id },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(tables.Last().Id, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarByExecutingAStoredProcedureWithMultipleParameters()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar("[dbo].[sp_multiply]",
                param: new { Value1 = 100, Value2 = 200 },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarByExecutingAStoredProcedureWithMultipleParametersAndWithOuputParameter()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Setup
            var output = new DirectionalQueryField("Output", ParameterDirection.Output, 16, DbType.Int32);
            var param = new[]
            {
                new QueryField("Value1", 100),
                new QueryField("Value2", 200),
                output
            };

            // Act
            var result = connection.ExecuteScalar("[dbo].[sp_multiply_with_output]",
                param: param,
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
            Assert.AreEqual(20000, output.Parameter.Value);
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public void ThrowExceptionOnTestSqlConnectionExecuteScalarIfTheParametersAreNotDefined()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.ExecuteScalar("SELECT * FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public void ThrowExceptionOnTestSqlConnectionExecuteScalarIfThereAreSqlStatementProblems()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.ExecuteScalar("SELECT FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    #endregion

    #region ExecuteScalarAsync

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithoutRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT * FROM (SELECT 1 AS Column1) TMP WHERE 1 = 0;");

            // Assert
            Assert.IsNull(result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithSingleRowAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT 1;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithMultipleRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT 2 UNION ALL SELECT 1;");

            // Assert
            Assert.AreEqual(2, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithSingleRowAndWithMultipleColumnsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT 1 AS Value1, 2 AS Value2;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithSingleParameterAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT @Value1;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithMultipleParametersAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = 1
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT @Value1, @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncWithMultipleParametersAndWithMultipleRowsAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = DateTime.UtcNow.AddDays(1)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT @Value1 AS Value1 UNION ALL SELECT @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncByExecutingAStoredProcedureWithSingleParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.ExecuteScalarAsync("[dbo].[sp_get_identity_table_by_id]",
                param: new { tables.Last().Id },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(tables.Last().Id, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncByExecutingAStoredProcedureWithMultipleParameters()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("[dbo].[sp_multiply]",
                param: new { Value1 = 100, Value2 = 200 },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarAsyncByExecutingAStoredProcedureWithMultipleParametersAndWithOuputParameter()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Setup
            var output = new DirectionalQueryField("Output", ParameterDirection.Output, 16, DbType.Int32);
            var param = new[]
            {
                new QueryField("Value1", 100),
                new QueryField("Value2", 200),
                output
            };

            // Act
            var result = await connection.ExecuteScalarAsync("[dbo].[sp_multiply_with_output]",
                param: param,
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
            Assert.AreEqual(20000, output.Parameter.Value);
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public async Task ThrowExceptionOnTestSqlConnectionExecuteScalarAsyncIfTheParametersAreNotDefined()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT * FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public async Task ThrowExceptionOnTestSqlConnectionExecuteScalarAsyncIfThereAreSqlStatementProblems()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync("SELECT FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    #endregion

    #region ExecuteScalar<T>

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithoutRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<object>("SELECT * FROM (SELECT 1 AS Column1) TMP WHERE 1 = 0;");

            // Assert
            Assert.IsNull(result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithSingleRowAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<int>("SELECT 1;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithMultipleRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<int>("SELECT 2 UNION ALL SELECT 1;");

            // Assert
            Assert.AreEqual(2, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithSingleRowAndWithMultipleColumnsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<int>("SELECT 1 AS Value1, 2 AS Value2;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithSingleParameterAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<DateTime>("SELECT @Value1;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithMultipleParametersAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = 1
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<DateTime>("SELECT @Value1, @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTWithMultipleParametersAndWithMultipleRowsAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = DateTime.UtcNow.AddDays(1)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<DateTime>("SELECT @Value1 AS Value1 UNION ALL SELECT @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTByExecutingAStoredProcedureWithSingleParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = connection.ExecuteScalar<long>("[dbo].[sp_get_identity_table_by_id]",
                param: new { tables.Last().Id },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(tables.Last().Id, result);
        }
    }

    [TestMethod]
    public void TestSqlConnectionExecuteScalarTByExecutingAStoredProcedureWithMultipleParameters()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = connection.ExecuteScalar<int>("[dbo].[sp_multiply]",
                param: new { Value1 = 100, Value2 = 200 },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public void ThrowExceptionOnTestSqlConnectionExecuteScalarTIfTheParametersAreNotDefined()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.ExecuteScalar<object>("SELECT * FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public void ThrowExceptionOnTestSqlConnectionExecuteScalarTIfThereAreSqlStatementProblems()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.ExecuteScalar<object>("SELECT FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    #endregion

    #region ExecuteScalarAsync<T>

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithoutRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<object>("SELECT * FROM (SELECT 1 AS Column1) TMP WHERE 1 = 0;");

            // Assert
            Assert.IsNull(result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithSingleRowAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<int>("SELECT 1;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithMultipleRowsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<int>("SELECT 2 UNION ALL SELECT 1;");

            // Assert
            Assert.AreEqual(2, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithSingleRowAndWithMultipleColumnsAsResult()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<int>("SELECT 1 AS Value1, 2 AS Value2;");

            // Assert
            Assert.AreEqual(1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithSingleParameterAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<DateTime>("SELECT @Value1;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithMultipleParametersAndWithSingleRowAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = 1
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<DateTime>("SELECT @Value1, @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncWithMultipleParametersAndWithMultipleRowsAsResult()
    {
        // Setup
        var param = new
        {
            Value1 = DateTime.UtcNow,
            Value2 = DateTime.UtcNow.AddDays(1)
        };

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<DateTime>("SELECT @Value1 AS Value1 UNION ALL SELECT @Value2;", param);

            // Assert
            Assert.AreEqual(param.Value1, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncByExecutingAStoredProcedureWithSingleParameter()
    {
        // Setup
        var tables = Helper.CreateIdentityTables(10);

        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            connection.InsertAll(tables);

            // Act
            var result = await connection.ExecuteScalarAsync<long>("[dbo].[sp_get_identity_table_by_id]",
                param: new { tables.Last().Id },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(tables.Last().Id, result);
        }
    }

    [TestMethod]
    public async Task TestSqlConnectionExecuteScalarTAsyncByExecutingAStoredProcedureWithMultipleParameters()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<int>("[dbo].[sp_multiply]",
                param: new { Value1 = 100, Value2 = 200 },
                commandType: CommandType.StoredProcedure);

            // Assert
            Assert.AreEqual(20000, result);
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public async Task ThrowExceptionOnTestSqlConnectionExecuteScalarTAsyncIfTheParametersAreNotDefined()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<object>("SELECT * FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    [TestMethod, ExpectedException(typeof(SqlException))]
    public async Task ThrowExceptionOnTestSqlConnectionExecuteScalarTAsyncIfThereAreSqlStatementProblems()
    {
        using (var connection = new SqlConnection(Database.ConnectionStringForRepoDb))
        {
            // Act
            var result = await connection.ExecuteScalarAsync<object>("SELECT FROM [sc].[IdentityTable] WHERE (Id = @Id);");
        }
    }

    #endregion
}
